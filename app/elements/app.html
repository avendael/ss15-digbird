<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="/bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="/bower_components/core-icons/social-icons.html">
<link rel="import" href="/bower_components/core-menu/core-menu.html">
<link rel="import" href="/bower_components/paper-dropdown/paper-dropdown.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="/bower_components/paper-item/paper-item.html">
<link rel="import" href="/bower_components/firebase-element/firebase-element.html">
<link rel="import" href="/bower_components/firebase-element/firebase-login.html">
<link rel="import" href="/bower_components/pvc-globals/pvc-globals.html">
<link rel="import" href="/bower_components/app-router/app-router.html">
<link rel="import" href="/bower_components/font-awesome-polymer-icons/fa-icons.html">


<polymer-element name="dig-bird-app">
  <template>
    <link rel="stylesheet" href="/styles/header.css">

    <firebase-login id="baseLogin"
                    user="{{user}}"
                    statusKnown="{{statusKnown}}"
                    location="{{globals.firebase_url}}"
                    provider="github"
                    on-login="{{onLogin}}"
                    on-error="{{onLoginError}}">
    </firebase-login>

    <firebase-element id="base"
                      location="{{globals.firebase_url}}/birdies"
                      data="{{birdies}}"
                      orderByChild="owner_id"
                      equalTo="{{globals.currentUser.uid}}"
                      keys="{{keys}}">
    </firebase-element>

    <pvc-globals values="{{globals}}"></pvc-globals>

    <core-header-panel>
      <div class="core-header">
        <core-toolbar>
          <div id="logo" flex>
            <a href="#">
              <img src="../images/logo.png">
            </a>
          </div>
          <paper-menu-button relative tabindex="0" id="topbar-menu">
            <paper-icon-button icon="social:person" role="button" tabindex="0" aria-label="menu"></paper-icon-button>
            <paper-dropdown class="dropdown" transition tabindex="-1">
              <core-menu class="menu">
                <paper-item tabindex="0"
                            on-click="{{login}}"
                            hidden?="{{!statusKnown || user}}">Login</paper-item>
                <paper-item tabindex="0"
                            on-click="{{logout}}"
                            hidden?="{{!statusKnown || !user}}">Logout</paper-item>
              </core-menu>
            </paper-dropdown>
          </paper-menu-button>
          <template if="{{user}}">{{user.github.username}}</template>
        </core-toolbar>
      </div>

      <div class="content">
        <app-router>
          <app-route path="/"
                     import="/elements/admin/main.html"
                     element="dig-bird-main">
          </app-route>
        </app-router>
      </div>

      <div id="sign-in" hidden?="{{globals.isLoggedIn || globals.isLoadingData}}">
        <paper-button raised on-click="{{login}}">
          <core-icon icon="fa:github"></core-icon>
          Sign In
        </paper-button>
      </div>

      <div id="marketspeak"
           hidden?="{{globals.isLoggedIn}}">
        <div class="panel">
          <h1>Make your carousels fly!</h1>
          <p>
            We take your carousels seriously. Stop worrying about creating an
            interface to update your carousels, or even worse, pushing to
            production just to add new content.
          </p>
        </div>
      </div>

      <footer layout horizontal center>
        <p><small>Built by Digbird for Staticshowdown</small></p>
      </footer>
    </core-header-panel>
  </template>
  <script>
    (function () {
      'use strict';

      Polymer({
        observe: {
          birdies: 'onBirdiesChanged',
        },
        onBirdiesChanged: function(oldValue, newValue) {
          this.globals.isLoadingData = false;
          this.globals.hasKeys = this.keys.length > 0;
          console.log('done loading');
        },

        ready: function() {
          var _this = this;
          this.globals.isLoadingData = true;
          this.globals.firebase_name = 'blazing-torch-2411'
          this.globals.firebase_url = 'https://' +
                                      this.globals.firebase_name +
                                      '.firebaseio.com';
          setTimeout(function() {
            _this.globals.isLoadingData = false;
          }, 2000);
        },
        login: function() {
          this.$.baseLogin.login();
        },
        logout: function() {
          this.$.baseLogin.logout();
          this.globals.isLoggedIn = false;
          this.globals.currentUser = null;
          this.globals.hasKeys = false;
        },
        onLogin: function() {
          this.globals.currentUser = this.user;
          this.globals.isLoggedIn = true;
        },
        onLoginError: function(err) {
          console.log('An error occurred.');
          console.error(err);
          this.globals.isLoggedIn = false;
        }
      });

    })();
  </script>
</polymer-element>
